version: '2'

services:
  python-flask-1:
    build: ./configs/sample-server
    container_name: python-flask-1
    cap_add:
      - SYS_PTRACE
    networks:
      - haproxy

  python-flask-2:
    build: ./configs/sample-server
    container_name: python-flask-2
    cap_add:
      - SYS_PTRACE
    networks:
      - haproxy

  haproxy:
    image: ${HAPROXY_IMAGE_REPOSITORY}:${HAPROXY_IMAGE_TAG}
    user: root
    volumes:
      - ./coverage_script.sh:/opt/bitnami/scripts/coverage_script.sh
      - ./configs/haproxy-tcp.cfg:/bitnami/haproxy/conf/haproxy.cfg
    container_name: haproxy
    networks:
      - haproxy
    cap_add:
      - SYS_PTRACE
    ports: 
      - '0.0.0.0::80'
    depends_on: 
      - python-flask-1
      - python-flask-2

networks:
  haproxy:
    driver: bridge
